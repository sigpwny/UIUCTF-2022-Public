From 6a37b8dacd5b79b2e45b05a354d4a6499e7ab295 Mon Sep 17 00:00:00 2001
From: YiFei Zhu <zhuyifei@google.com>
Date: Fri, 24 Jun 2022 21:19:02 -0700
Subject: [PATCH 1/5] PiSmmCore: Fix for CVE-2021-38578 integer underflow

Vanilla EDK-II does not seem to be exploitable, since the BufferSize
gets checked again by individual SMM modules. Patch it here anyways
since it's not how you are going to solve the chal.

This is not how upstream patched this CVE. Upstream seemed to have
never did anything. I'm guessing this is due to a lack of a
compiler-independent way to check for underflows?

Signed-off-by: YiFei Zhu <zhuyifei@google.com>
---
 MdeModulePkg/Core/PiSmmCore/PiSmmCore.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/MdeModulePkg/Core/PiSmmCore/PiSmmCore.c b/MdeModulePkg/Core/PiSmmCore/PiSmmCore.c
index 9e5c6cbe33..b3faa9434f 100644
--- a/MdeModulePkg/Core/PiSmmCore/PiSmmCore.c
+++ b/MdeModulePkg/Core/PiSmmCore/PiSmmCore.c
@@ -651,6 +651,7 @@ SmmEntryPoint (
   EFI_SMM_COMMUNICATE_HEADER  *CommunicateHeader;
   BOOLEAN                     InLegacyBoot;
   BOOLEAN                     IsOverlapped;
+  BOOLEAN                     BufferSizeUnderflow;
   VOID                        *CommunicationBuffer;
   UINTN                       BufferSize;
 
@@ -699,7 +700,12 @@ SmmEntryPoint (
                        (UINT8 *)gSmmCorePrivate,
                        sizeof (*gSmmCorePrivate)
                        );
-      if (!SmmIsBufferOutsideSmmValid ((UINTN)CommunicationBuffer, BufferSize) || IsOverlapped) {
+      BufferSizeUnderflow = __builtin_sub_overflow_p (
+                              BufferSize,
+                              OFFSET_OF (EFI_SMM_COMMUNICATE_HEADER, Data),
+                              BufferSize
+                              );
+      if (!SmmIsBufferOutsideSmmValid ((UINTN)CommunicationBuffer, BufferSize) || IsOverlapped || BufferSizeUnderflow) {
         //
         // If CommunicationBuffer is not in valid address scope,
         // or there is overlap between gSmmCorePrivate and CommunicationBuffer,
-- 
2.35.1

